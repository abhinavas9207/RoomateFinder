{% extends 'base_user.html' %}
{% block title %}Chat{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="card shadow-sm rounded-4">

    <div class="card-header bg-primary text-white">
      Chat with 
      {% for user in chat.participants.all %}
        {% if user != request.user %} {{ user.username }} {% endif %}
      {% endfor %}
    </div>

    <div class="card-body" id="chat-messages" style="height:400px; overflow-y:auto; background:#f8f9fa;">
      {% for msg in messages %}
        <div class="mb-2 d-flex {% if msg.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %}">
          <span class="badge {% if msg.sender == request.user %}bg-primary{% else %}bg-secondary{% endif %} p-2 text-wrap" style="max-width:70%;">
            <strong>{{ msg.sender.username }}:</strong> {{ msg.message }}
          </span>
        </div>
      {% empty %}
        <p class="text-center text-muted">No messages yet.</p>
      {% endfor %}
    </div>

    <div class="card-footer bg-white">
      <form id="chat-form" class="d-flex gap-2">
        <input type="text" id="message-input" class="form-control" placeholder="Type a message..." autocomplete="off">
        <button type="submit" class="btn btn-primary">Send</button>
      </form>
    </div>

  </div>
</div>

<script>
const chatId = {{ chat.id }};
const csrfToken = "{{ csrf_token }}";
const chatMessages = document.getElementById('chat-messages');

document.getElementById('chat-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const input = document.getElementById('message-input');
  const message = input.value.trim();
  if (!message) return;

  fetch(`/chat/send/${chatId}/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": csrfToken,
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: "message=" + encodeURIComponent(message)
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      const div = document.createElement('div');
      div.className = 'mb-2 d-flex justify-content-end';
      div.innerHTML = `<span class="badge bg-primary p-2 text-wrap" style="max-width:70%;"><strong>{{ request.user.username }}:</strong> ${message}</span>`;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      input.value = '';
      input.focus();
    }
  });
});

// Scroll to bottom
chatMessages.scrollTop = chatMessages.scrollHeight;
</script>
{% endblock %}
