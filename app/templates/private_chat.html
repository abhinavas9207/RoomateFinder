{% extends 'base_user.html' %}
{% block title %}Chat{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="card shadow-sm rounded-4">

    <div class="card-header bg-primary text-white">
      Chat with 
      {% for user in chat.participants.all %}
        {% if user != request.user %} {{ user.username }} {% endif %}
      {% endfor %}
    </div>

    <div class="card-body" id="chat-messages" style="height:400px; overflow-y:auto; background:#f8f9fa;">
      {% for msg in messages %}
        <div class="mb-2 d-flex {% if msg.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %}">
          <span class="badge {% if msg.sender == request.user %}bg-primary{% else %}bg-secondary{% endif %} p-2 text-wrap" style="max-width:70%;">
            <strong>{{ msg.sender.username }}:</strong> {{ msg.message }}
          </span>
        </div>
      {% empty %}
        <p class="text-center text-muted">No messages yet.</p>
      {% endfor %}
    </div>

    <div class="card-footer bg-white">
      <form id="chat-form" class="d-flex gap-2">
        <input type="text" id="message-input" class="form-control" placeholder="Type a message..." autocomplete="off">
        <button type="submit" class="btn btn-primary">Send</button>
      </form>
    </div>

  </div>
</div>

<script>
const chatId = {{ chat.id }};
const chatMessages = document.getElementById("chat-messages");
const input = document.getElementById("message-input");

const socket = new WebSocket(
  `ws://${window.location.host}/ws/chat/${chatId}/`
);

socket.onmessage = function(e) {
  const data = JSON.parse(e.data);
  const isMe = data.sender === "{{ request.user.username }}";

  const div = document.createElement("div");
  div.className = `mb-2 d-flex ${isMe ? "justify-content-end" : "justify-content-start"}`;
  div.innerHTML = `
    <span class="badge ${isMe ? "bg-primary" : "bg-secondary"} p-2 text-wrap" style="max-width:70%;">
      <strong>${data.sender}:</strong> ${data.message}
    </span>
  `;

  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
};

document.getElementById("chat-form").onsubmit = function(e) {
  e.preventDefault();
  if (input.value.trim() !== "") {
    socket.send(JSON.stringify({
      message: input.value
    }));
    input.value = "";
  }
};
</script>

{% endblock %}
